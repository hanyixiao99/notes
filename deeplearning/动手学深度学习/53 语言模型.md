# 53 è¯­è¨€æ¨¡å‹

<!--è¯­è¨€æ¨¡å‹ä¼°è®¡æ–‡æœ¬åºåˆ—çš„è”åˆæ¦‚ç‡-->

<!--ä½¿ç”¨ç»Ÿè®¡æ–¹æ³•æ—¶å¸¸é‡‡ç”¨nå…ƒè¯­æ³•-->

ç»™å®šæ–‡æœ¬åºåˆ—x_1,...,x_Tï¼Œè¯­è¨€æ¨¡å‹çš„ç›®æ ‡æ˜¯ä¼°è®¡è”åˆæ¦‚ç‡p(x1,...,xT)

å®ƒçš„åº”ç”¨åŒ…æ‹¬

- åšé¢„è®­ç»ƒæ¨¡å‹ï¼ˆBERTï¼ŒGPT-3ï¼‰
- ç”Ÿæˆæ–‡æœ¬
- åˆ¤æ–­å¤šä¸ªåºåˆ—ä¸­å“ªä¸ªæ›´å¸¸è§

## ä½¿ç”¨è®¡æ•°æ¥å»ºæ¨¡

å‡è®¾åºåˆ—é•¿åº¦ä¸º2ï¼Œæˆ‘ä»¬é¢„æµ‹

<img src="/Users/hanyixiao/Library/Application Support/typora-user-images/æˆªå±2021-12-16 14.04.03.png" alt="æˆªå±2021-12-16 14.04.03" style="zoom:50%;" />

- è¿™é‡Œnæ˜¯æ€»è¯æ•°ï¼Œn(x)ï¼Œn(x,x')æ˜¯å•ä¸ªå•è¯å’Œè¿ç»­å•è¯å¯¹çš„å‡ºç°æ¬¡æ•°

å¾ˆå®¹æ˜“æ‹“å±•åˆ°é•¿åº¦ä¸º3çš„æƒ…å†µ

<img src="/Users/hanyixiao/Library/Application Support/typora-user-images/æˆªå±2021-12-16 14.13.25.png" alt="æˆªå±2021-12-16 14.13.25" style="zoom:50%;" />

### Nå…ƒè¯­æ³•

å½“åºåˆ—å¾ˆé•¿æ—¶ï¼Œå› ä¸ºæ–‡æœ¬é‡ä¸å¤Ÿå¤§ï¼Œå¾ˆå¯èƒ½n(x1,...,xT) å°äºæˆ–ç­‰äº1

ä½¿ç”¨é©¬å°”å¯å¤«å‡è®¾å¯ä»¥ç¼“è§£è¿™ä¸ªé—®é¢˜

- ä¸€å…ƒè¯­æ³•ï¼ˆtau=0ï¼‰

  <img src="/Users/hanyixiao/Library/Application Support/typora-user-images/æˆªå±2021-12-16 14.15.36.png" alt="æˆªå±2021-12-16 14.15.36" style="zoom:50%;" />

- äºŒå…ƒè¯­æ³•ï¼ˆtau=1ï¼‰

  <img src="/Users/hanyixiao/Library/Application Support/typora-user-images/æˆªå±2021-12-16 14.17.34.png" alt="æˆªå±2021-12-16 14.17.34" style="zoom:50%;" />

- ä¸‰å…ƒè¯­æ³•ï¼ˆtau=2ï¼‰

  <img src="/Users/hanyixiao/Library/Application Support/typora-user-images/æˆªå±2021-12-16 14.17.50.png" alt="æˆªå±2021-12-16 14.17.50" style="zoom:50%;" />

## ä»£ç å®ç°

```python
import random
import torch
from d2l import torch as d2l

tokens = d2l.tokenize(d2l.read_time_machine())
# å› ä¸ºæ¯ä¸ªæ–‡æœ¬è¡Œä¸ä¸€å®šæ˜¯ä¸€ä¸ªå¥å­æˆ–ä¸€ä¸ªæ®µè½ï¼Œå› æ­¤æˆ‘ä»¬æŠŠæ‰€æœ‰æ–‡æœ¬è¡Œæ‹¼æ¥åˆ°ä¸€èµ·
corpus = [token for line in tokens for token in line]
vocab = d2l.Vocab(corpus)
vocab.token_freqs[:10]
# [('the', 2261),
#  ('i', 1267),
#  ('and', 1245),
#  ('of', 1155),
#  ('a', 816),
#  ('to', 695),
#  ('was', 552),
#  ('in', 541),
#  ('that', 443),
#  ('my', 440)]
```

è¿™äº›è¯é€šå¸¸è¢«ç§°ä¸ºåœç”¨è¯ï¼ˆstop wordsï¼‰ï¼Œå› æ­¤å¯ä»¥è¢«è¿‡æ»¤æ‰ã€‚å°½ç®¡å¦‚æ­¤ï¼Œå®ƒä»¬æœ¬èº«ä»ç„¶æ˜¯æœ‰æ„ä¹‰çš„

ç”»å‡ºè¯é¢‘å›¾

```python
freqs = [freq for token, freq in vocab.token_freqs]
d2l.plot(freqs, xlabel='token: x', ylabel='frequency: n(x)',
         xscale='log', yscale='log')
```

<img src="/Users/hanyixiao/Library/Application Support/typora-user-images/æˆªå±2021-12-16 14.26.54.png" alt="æˆªå±2021-12-16 14.26.54" style="zoom:50%;" />

å°†å‰å‡ ä¸ªå•è¯ä½œä¸ºä¾‹å¤–æ¶ˆé™¤åï¼Œå‰©ä½™çš„æ‰€æœ‰å•è¯å¤§è‡´éµå¾ªåŒå¯¹æ•°åæ ‡å›¾ä¸Šçš„ä¸€æ¡ç›´çº¿

è¿™æ„å‘³ç€å•è¯çš„é¢‘ç‡æ»¡è¶³*é½æ™®å¤«å®šå¾‹*ï¼ˆZipfâ€™s lawï¼‰

<img src="/Users/hanyixiao/Library/Application Support/typora-user-images/æˆªå±2021-12-16 14.29.29.png" alt="æˆªå±2021-12-16 14.29.29" style="zoom:50%;" />

å…¶ä¸­ğ›¼æ˜¯åˆ»ç”»åˆ†å¸ƒçš„æŒ‡æ•°ï¼Œğ‘æ˜¯å¸¸æ•°

å…¶ä»–çš„è¯å…ƒç»„åˆ

```python
bigram_tokens = [pair for pair in zip(corpus[:-1], corpus[1:])]
bigram_vocab = d2l.Vocab(bigram_tokens)
bigram_vocab.token_freqs[:10]
# [(('of', 'the'), 309),
#  (('in', 'the'), 169),
#  (('i', 'had'), 130),
#  (('i', 'was'), 112),
#  (('and', 'the'), 109),
#  (('the', 'time'), 102),
#  (('it', 'was'), 99),
#  (('to', 'the'), 85),
#  (('as', 'i'), 78),
#  (('of', 'a'), 73)]
```

```python
trigram_tokens = [triple for triple in zip(
    corpus[:-2], corpus[1:-1], corpus[2:])]
trigram_vocab = d2l.Vocab(trigram_tokens)
trigram_vocab.token_freqs[:10]
# [(('the', 'time', 'traveller'), 59),
#  (('the', 'time', 'machine'), 30),
#  (('the', 'medical', 'man'), 24),
#  (('it', 'seemed', 'to'), 16),
#  (('it', 'was', 'a'), 15),
#  (('here', 'and', 'there'), 15),
#  (('seemed', 'to', 'me'), 14),
#  (('i', 'did', 'not'), 14),
#  (('i', 'saw', 'the'), 13),
#  (('i', 'began', 'to'), 13)]
```

ç›´è§‚åœ°æ¯”è¾ƒ

```python
bigram_freqs = [freq for token, freq in bigram_vocab.token_freqs]
trigram_freqs = [freq for token, freq in trigram_vocab.token_freqs]
d2l.plot([freqs, bigram_freqs, trigram_freqs], xlabel='token: x',
         ylabel='frequency: n(x)', xscale='log', yscale='log',
         legend=['unigram', 'bigram', 'trigram'])
```

<img src="/Users/hanyixiao/Library/Application Support/typora-user-images/æˆªå±2021-12-16 14.32.27.png" alt="æˆªå±2021-12-16 14.32.27" style="zoom:50%;" />

éšæœºç”Ÿæˆä¸€ä¸ªå°æ‰¹é‡æ•°æ®çš„ç‰¹å¾å’Œæ ‡ç­¾ä»¥ä¾›è¯»å–

åœ¨==éšæœºé‡‡æ ·==ä¸­ï¼Œæ¯ä¸ªæ ·æœ¬éƒ½æ˜¯åœ¨åŸå§‹çš„é•¿åºåˆ—ä¸Šä»»æ„æ•è·çš„å­åºåˆ—

```python
def seq_data_iter_random(corpus, batch_size, num_steps):
    """ä½¿ç”¨éšæœºæŠ½æ ·ç”Ÿæˆä¸€ä¸ªå°æ‰¹é‡å­åºåˆ—"""
    # ä»éšæœºåç§»é‡å¼€å§‹å¯¹åºåˆ—è¿›è¡Œåˆ†åŒºï¼ŒéšæœºèŒƒå›´åŒ…æ‹¬num_steps-1
    corpus = corpus[random.randint(0, num_steps - 1):]
    # å‡å»1ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦è€ƒè™‘æ ‡ç­¾
    num_subseqs = (len(corpus) - 1) // num_steps
    # é•¿åº¦ä¸ºnum_stepsçš„å­åºåˆ—çš„èµ·å§‹ç´¢å¼•
    initial_indices = list(range(0, num_subseqs * num_steps, num_steps))
    # åœ¨éšæœºæŠ½æ ·çš„è¿­ä»£è¿‡ç¨‹ä¸­ï¼Œ
    # æ¥è‡ªä¸¤ä¸ªç›¸é‚»çš„ã€éšæœºçš„ã€å°æ‰¹é‡ä¸­çš„å­åºåˆ—ä¸ä¸€å®šåœ¨åŸå§‹åºåˆ—ä¸Šç›¸é‚»
    random.shuffle(initial_indices)

    def data(pos):
        # è¿”å›ä»posä½ç½®å¼€å§‹çš„é•¿åº¦ä¸ºnum_stepsçš„åºåˆ—
        return corpus[pos: pos + num_steps]

    num_batches = num_subseqs // batch_size
    for i in range(0, batch_size * num_batches, batch_size):
        # åœ¨è¿™é‡Œï¼Œinitial_indicesåŒ…å«å­åºåˆ—çš„éšæœºèµ·å§‹ç´¢å¼•
        initial_indices_per_batch = initial_indices[i: i + batch_size]
        X = [data(j) for j in initial_indices_per_batch]
        Y = [data(j + 1) for j in initial_indices_per_batch]
        yield torch.tensor(X), torch.tensor(Y)
```

Xæ˜¯ä¸€ä¸ªé•¿ä¸º5çš„åºåˆ—ï¼Œå› ä¸ºæ‰¹é‡å¤§å°ä¸º2æ‰€ä»¥æœ‰ä¸¤ä¸ªæ ·æœ¬ï¼ŒYæ˜¯Xçš„åä¸€ä¸ª

ä»¥ç¬¬ä¸€ä¸ªè¾“å‡ºç»“æœä¸ºä¾‹

- Xï¼š21 é¢„æµ‹ Yï¼š22
- Xï¼š21ã€22 é¢„æµ‹ Yï¼š23
- Xï¼š21ã€22ã€23 é¢„æµ‹Yï¼š24
- â€¦

```python
my_seq = list(range(35))
for X, Y in seq_data_iter_random(my_seq, batch_size=2, num_steps=5):
    print('X: ', X, '\nY:', Y)
# X:  tensor([[21, 22, 23, 24, 25],
#         [ 6,  7,  8,  9, 10]]) 
# Y: tensor([[22, 23, 24, 25, 26],
#         [ 7,  8,  9, 10, 11]])
# X:  tensor([[ 1,  2,  3,  4,  5],
#         [16, 17, 18, 19, 20]]) 
# Y: tensor([[ 2,  3,  4,  5,  6],
#         [17, 18, 19, 20, 21]])
# X:  tensor([[26, 27, 28, 29, 30],
#         [11, 12, 13, 14, 15]]) 
# Y: tensor([[27, 28, 29, 30, 31],
#         [12, 13, 14, 15, 16]])
```

==é¡ºåºåˆ†åŒº==ï¼šä¿è¯ä¸¤ä¸ªç›¸é‚»çš„å°æ‰¹é‡ä¸­çš„å­åºåˆ—åœ¨åŸå§‹åºåˆ—ä¸Šä¹Ÿæ˜¯ç›¸é‚»çš„

```python
def seq_data_iter_sequential(corpus, batch_size, num_steps):  #@save
    """ä½¿ç”¨é¡ºåºåˆ†åŒºç”Ÿæˆä¸€ä¸ªå°æ‰¹é‡å­åºåˆ—"""
    # ä»éšæœºåç§»é‡å¼€å§‹åˆ’åˆ†åºåˆ—
    offset = random.randint(0, num_steps)
    num_tokens = ((len(corpus) - offset - 1) // batch_size) * batch_size
    Xs = torch.tensor(corpus[offset: offset + num_tokens])
    Ys = torch.tensor(corpus[offset + 1: offset + 1 + num_tokens])
    Xs, Ys = Xs.reshape(batch_size, -1), Ys.reshape(batch_size, -1)
    num_batches = Xs.shape[1] // num_steps
    for i in range(0, num_steps * num_batches, num_steps):
        X = Xs[:, i: i + num_steps]
        Y = Ys[:, i: i + num_steps]
        yield X, Y
```

```python
for X, Y in seq_data_iter_sequential(my_seq, batch_size=2, num_steps=5):
    print('X: ', X, '\nY:', Y)
# X:  tensor([[ 1,  2,  3,  4,  5],
#         [17, 18, 19, 20, 21]]) 
# Y: tensor([[ 2,  3,  4,  5,  6],
#         [18, 19, 20, 21, 22]])
# X:  tensor([[ 6,  7,  8,  9, 10],
#         [22, 23, 24, 25, 26]]) 
# Y: tensor([[ 7,  8,  9, 10, 11],
#         [23, 24, 25, 26, 27]])
# X:  tensor([[11, 12, 13, 14, 15],
#         [27, 28, 29, 30, 31]]) 
# Y: tensor([[12, 13, 14, 15, 16],
#         [28, 29, 30, 31, 32]])
```